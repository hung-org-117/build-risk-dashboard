@startuml
'===============================================================
' SYSTEM ARCHITECTURE OVERVIEW - BUILD RISK DASHBOARD
'===============================================================
skinparam rectangle {
  BorderColor #333333
  BackgroundColor #F9F9F9
}
skinparam componentStyle rectangle

actor "Admin/User/Guest" as User

rectangle "Frontend (Next.js 14)" as FE {
  component "Dashboard UI\n(Tables, Cards,\nCharts, DAG viewer)" as FE_UI
  component "Auth & Session\n(OAuth, RBAC)" as FE_Auth
  component "WebSocket Client\n(Live updates)" as FE_WS
  FE_UI -down-> FE_Auth
  FE_UI -down-> FE_WS
}

rectangle "API Layer (FastAPI)" as API {
  component "Routers\n(Auth, Repos,\nBuilds, Datasets,\nMonitoring, Settings)" as API_R
  component "Pydantic DTOs\nValidation" as API_DTO
  API_R -down-> API_DTO
}

rectangle "Services" as SVC {
  component "Repository Service\n(GitHub onboarding,\nwebhooks/backfill)" as S_REPO
  component "Build/Feature Service\n(Hamilton DAG, parsing)" as S_FEAT
  component "Dataset Service\n(Validation, enrichment)" as S_DATA
  component "Notification Service\n(Events, feed)" as S_NOTI
  component "Scan Service\n(SonarQube/Trivy)" as S_SCAN
}

rectangle "Async Workers (Celery)" as CELERY {
  component "Ingestion Queue\n(clone, fetch runs)" as Q_INGEST
  component "Processing Queue\n(feature extraction)" as Q_PROCESS
  component "Scan Queues\n(sonar_scan, trivy_scan)" as Q_SCAN
  component "Enrichment Queue\n(dataset jobs)" as Q_ENRICH
}

rectangle "Data & Cache" as DATA {
  database "MongoDB\n(users, repos,\nbuilds, features,\ndatasets, scans,\nnotifications)" as DB
  collections "Redis\n(cache, token pool,\nCelery backend)" as CACHE
}

rectangle "Integrations" as EXT {
  node "GitHub\nAPI/Webhooks" as GITHUB
  node "SonarQube" as SONAR
  node "Trivy" as TRIVY
}

User --> FE_UI : Browse/Actions
FE_Auth --> API_R : OAuth JWT
FE_UI --> API_R : REST/HTTPS
FE_WS --> API_R : WebSocket

API_R --> S_REPO
API_R --> S_FEAT
API_R --> S_DATA
API_R --> S_NOTI
API_R --> S_SCAN

S_REPO --> Q_INGEST
S_FEAT --> Q_PROCESS
S_DATA --> Q_ENRICH
S_SCAN --> Q_SCAN
S_NOTI --> DB

Q_INGEST --> DB
Q_PROCESS --> DB
Q_ENRICH --> DB
Q_SCAN --> DB

S_REPO --> GITHUB
Q_INGEST --> GITHUB
Q_PROCESS --> GITHUB
Q_SCAN --> SONAR
Q_SCAN --> TRIVY

S_REPO --> CACHE : GitHub token pool
S_FEAT --> CACHE : Intermediate cache
CELERY --> CACHE : Task backend
API_R --> CACHE : Session/cache
API_R --> DB

DB <-- FE_UI : Read (via API)
DB <-- FE_WS : Live updates (via API)

@enduml
