@startuml
'===============================================================
' BACKEND ARCHITECTURE - FASTAPI + CELERY + HAMILTON
'===============================================================
skinparam componentStyle rectangle
skinparam rectangle {
  BorderColor #333333
  BackgroundColor #F5F5F5
}

rectangle "Routers (FastAPI)" as ROUTERS {
  component "auth.py\n(login, tokens)" as R_AUTH
  component "repositories.py\n(onboarding, webhooks)" as R_REPO
  component "builds.py\n(list, details)" as R_BUILD
  component "datasets.py\n(upload, validate,\nenrich, export)" as R_DATA
  component "monitoring.py\n(pipeline runs,\nlogs)" as R_MON
  component "notifications.py\n(feed, settings)" as R_NOTI
  component "settings.py\n(integrations)" as R_CFG
}

rectangle "Services" as SVC {
  component "AuthService" as S_AUTH
  component "RepositoryService" as S_REPO
  component "BuildService" as S_BUILD
  component "DatasetService/\nDatasetVersionService" as S_DATA
  component "FeatureService\n(HamiltonPipeline)" as S_FEAT
  component "NotificationService" as S_NOTI
  component "ScanService\n(SonarQube/Trivy)" as S_SCAN
  component "SettingsService" as S_SETTINGS
}

rectangle "Repositories (DAO)" as DAO {
  component "UserRepo\nOAuth identities" as D_USER
  component "RepoRepo\nraw_repositories" as D_REPO
  component "BuildRepo\nraw_build_runs" as D_BUILD
  component "PipelineRunRepo\nexecution logs" as D_PIPE
  component "DatasetRepo /\nDatasetVersionRepo" as D_DATA
  component "NotificationRepo" as D_NOTI
  component "SettingsRepo" as D_CFG
}

rectangle "Tasks / Queues (Celery)" as TASKS {
  component "ingestion\n(clone, fetch runs)" as T_INGEST
  component "processing\n(feature DAG)" as T_PROCESS
  component "enrichment\n(dataset)" as T_ENRICH
  component "sonar_scan\n(triggers SonarQube)" as T_SONAR
  component "trivy_scan\n(vuln scan)" as T_TRIVY
}

rectangle "Pipeline (Hamilton)" as PIPE {
  component "feature_dag/\nbuild_features.py" as F_BUILD
  component "feature_dag/\ngit_features.py" as F_GIT
  component "feature_dag/\ngithub_features.py" as F_GH
  component "feature_dag/\nrepo_features.py" as F_REPO
  component "feature_dag/\nlog_features.py" as F_LOG
  component "ExecutionTracker\nnode timings/errors" as F_TRACK
}

database "MongoDB" as DB
collections "Redis\ncache + token pool\nCelery backend" as CACHE
node "RabbitMQ\nbroker" as MQ
node "GitHub API\n/Webhooks" as GH
node "SonarQube" as SONAR
node "Trivy" as TRIVY

R_AUTH --> S_AUTH
R_REPO --> S_REPO
R_BUILD --> S_BUILD
R_DATA --> S_DATA
R_MON --> S_FEAT
R_MON --> S_REPO
R_NOTI --> S_NOTI
R_CFG --> S_SETTINGS

S_REPO --> D_REPO
S_BUILD --> D_BUILD
S_DATA --> D_DATA
S_FEAT --> D_PIPE
S_NOTI --> D_NOTI
S_SETTINGS --> D_CFG
S_AUTH --> D_USER

S_REPO --> GH
S_BUILD --> GH
S_FEAT --> GH
S_SCAN --> SONAR
S_SCAN --> TRIVY
S_REPO --> CACHE : GitHub token pool
S_FEAT --> CACHE : DAG cache (opt)
S_AUTH --> CACHE : sessions

S_REPO --> MQ : enqueue ingestion
S_BUILD --> MQ : enqueue processing
S_DATA --> MQ : enqueue enrichment
S_SCAN --> MQ : enqueue scans

MQ --> TASKS

T_INGEST --> GH
T_INGEST --> DB
T_PROCESS --> PIPE
T_PROCESS --> DB
T_ENRICH --> PIPE
T_ENRICH --> DB
T_SONAR --> SONAR
T_TRIVY --> TRIVY
T_SONAR --> DB
T_TRIVY --> DB

PIPE --> DB : Feature vectors
PIPE --> F_TRACK
F_TRACK --> D_PIPE

@enduml
