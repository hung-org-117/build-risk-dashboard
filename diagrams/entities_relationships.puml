@startuml entities_relationships
!theme plain
left to right direction
hide methods
skinparam classAttributeIconSize 0

title Build Risk Dashboard - Entity Relationships

note "All entity models extend BaseEntity (id, created_at, updated_at) stored in MongoDB.\nObjectId fields ending with _id are references." as BaseNote

class BaseEntity

class RepoConfigBase {
  source_languages
  test_frameworks
  ci_provider
}

BaseEntity <|-- RepoConfigBase

package "Users & Auth" {
  class User
  class OAuthIdentity {
    user_id
    provider
  }
  class GithubInstallation {
    installation_id
  }
}

package "Raw Data" {
  class RawRepository {
    full_name
  }
  class RawBuildRun {
    raw_repo_id
    build_id
  }
}

package "Configurations" {
  class ModelRepoConfig {
    user_id
    raw_repo_id
  }
  class DatasetRepoConfig {
    dataset_id
    raw_repo_id
    repo_name_from_csv
  }
  RepoConfigBase <|-- ModelRepoConfig
  RepoConfigBase <|-- DatasetRepoConfig
}

package "Dataset Flow" {
  class DatasetProject {
    user_id
    name
  }
  class DatasetBuild {
    dataset_id
    repo_id
    workflow_run_id
  }
  class DatasetEnrichmentBuild {
    dataset_id
    dataset_version_id
    dataset_repo_config_id
    raw_repo_id
    raw_build_run_id
  }
  class DatasetVersion {
    dataset_id
    user_id
    version_number
  }
  class DatasetScan {
    dataset_id
    user_id
    tool_type
  }
  class DatasetScanResult {
    scan_id
    dataset_id
    commit_sha
  }
  class DatasetTemplate {
    name
    feature_names
  }
}

package "Model Training" {
  class ModelTrainingBuild {
    model_repo_config_id
    raw_repo_id
    raw_build_run_id
  }
}

package "Scanning Jobs" {
  class ScanJob {
    repo_id
    build_id
  }
  class ScanResult {
    repo_id
    job_id
  }
  class FailedScan {
    repo_id
    build_id
    job_id
  }
  class ExportJob {
    repo_id
    user_id
  }
  class SonarScanPending {
    build_id
    build_type
    component_key
  }
}

package "Pipelines" {
  class PipelineRun {
    build_sample_id
    repo_id
    workflow_run_id
  }
}

package "Settings" {
  class ApplicationSettings {
    settings_version
  }
  class CircleCISettings
  class TravisCISettings
  class SonarQubeSettings
  class TrivySettings
  class SlackNotificationSettings

  ApplicationSettings *-- CircleCISettings : circleci
  ApplicationSettings *-- TravisCISettings : travis
  ApplicationSettings *-- SonarQubeSettings : sonarqube
  ApplicationSettings *-- TrivySettings : trivy
  ApplicationSettings *-- SlackNotificationSettings : slack
}

BaseNote .. BaseEntity

RawRepository "1" <-- "*" RawBuildRun : raw_repo_id
RawRepository "1" <-- "*" ModelRepoConfig : raw_repo_id
RawRepository "1" <-- "0..*" DatasetRepoConfig : raw_repo_id (optional)
RawRepository "1" <-- "*" ModelTrainingBuild : raw_repo_id
RawRepository "1" <-- "*" DatasetEnrichmentBuild : raw_repo_id
RawRepository "1" <-- "0..*" DatasetBuild : repo_id (optional)
RawRepository "1" <-- "*" ExportJob : repo_id
RawRepository "1" <-- "*" ScanJob : repo_id
RawRepository "1" <-- "*" ScanResult : repo_id
RawRepository "1" <-- "*" FailedScan : repo_id
RawRepository "1" <-- "*" PipelineRun : repo_id

RawBuildRun "1" <-- "*" ModelTrainingBuild : raw_build_run_id
RawBuildRun "1" <-- "*" DatasetEnrichmentBuild : raw_build_run_id
RawBuildRun "1" <-- "0..*" DatasetBuild : workflow_run_id (optional)
RawBuildRun "1" <-- "*" ScanJob : build_id
RawBuildRun "1" <-- "*" FailedScan : build_id

DatasetProject "1" <-- "*" DatasetBuild : dataset_id
DatasetProject "1" <-- "*" DatasetRepoConfig : dataset_id
DatasetProject "1" <-- "*" DatasetEnrichmentBuild : dataset_id
DatasetProject "1" <-- "*" DatasetScan : dataset_id
DatasetProject "1" <-- "*" DatasetScanResult : dataset_id
DatasetProject "1" <-- "*" DatasetVersion : dataset_id

DatasetRepoConfig "0..1" <-- "0..*" DatasetEnrichmentBuild : dataset_repo_config_id
DatasetVersion "0..1" <-- "0..*" DatasetEnrichmentBuild : dataset_version_id
ModelRepoConfig "1" <-- "*" ModelTrainingBuild : model_repo_config_id
DatasetScan "1" <-- "*" DatasetScanResult : scan_id

User "0..1" <-- "*" DatasetProject : user_id (optional)
User "1" <-- "*" ModelRepoConfig : user_id
User "1" <-- "*" DatasetScan : user_id
User "1" <-- "*" DatasetVersion : user_id
User "1" <-- "*" ExportJob : user_id
User "1" <-- "*" OAuthIdentity : user_id

SonarScanPending --> ModelTrainingBuild : build_id (build_type=model)
SonarScanPending --> DatasetEnrichmentBuild : build_id (build_type=enrichment)

@enduml
