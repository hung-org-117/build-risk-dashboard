version: "3.8"

services:
  # =========================================
  # LOCAL APPLICATION (Frontend & API)
  # =========================================

  # Backend API Server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: build-risk-backend-local
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    environment:
      # Connect to Remote Server Infrastructure
      # User must set SERVER_HOST in .env or shell. Default is localhost (if SSH tunneling)
      MONGODB_URI: mongodb://${SERVER_HOST:-localhost}:27017
      MONGODB_DB_NAME: buildguard
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-myuser}:${RABBITMQ_PASS:-mypass}@${SERVER_HOST:-localhost}:5672//
      REDIS_URL: redis://${SERVER_HOST:-localhost}:6379/0
      
      DEBUG: "True"
      
      # SonarQube (Remote)
      SONAR_HOST_URL: http://${SERVER_HOST:-localhost}:9000
      SONAR_TOKEN: ${SONAR_TOKEN:-}
      SONAR_DEFAULT_PROJECT_KEY: build-risk-ui
      SONAR_WEBHOOK_SECRET: ${SONAR_WEBHOOK_SECRET:-change-me}
      # Public URL that SonarQube Server can reach to send webhooks back to this local instance
      # NOTE: This usually requires a tunnel (ngrok) or VPN if Local is behind NAT.
      SONAR_WEBHOOK_PUBLIC_URL: ${SONAR_WEBHOOK_PUBLIC_URL:-http://host.docker.internal:8000/api/sonar/webhook}

      # GitHub App
      GITHUB_APP_ID: ${GITHUB_APP_ID:-}
      GITHUB_APP_PRIVATE_KEY: ${GITHUB_APP_PRIVATE_KEY:-}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-}
      GITHUB_INSTALLATION_ID: ${GITHUB_INSTALLATION_ID:-}
      
      SECRET_KEY: ${SECRET_KEY:-local-dev-secret}
      DATA_DIR: /app/repo-data/data

    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      # Mount repo-data purely for read-only checks if needed, 
      # but heavy lifting is done by remote worker. 
      # Actually, API might need it for some lightweight git checks (e.g. log reading?)
      # Ideally, API shouldn't depend on repo-data if worker handles everything.
      # But current code might expect it.
      - ./repo-data:/app/repo-data
    restart: unless-stopped

  # Frontend Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: build-risk-frontend-local
    command: npm run dev
    environment:
      # Browser talks to API. If API is local docker, localhost:8000 works.
      NEXT_PUBLIC_API_URL: http://localhost:8000/api
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    restart: unless-stopped
